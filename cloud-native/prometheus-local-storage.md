---
title: "Prometheus本地存储"
date: 2020-09-04T16:10:02+08:00
description: ""
draft: false
tags: []
categories: [监控]
---

Prometheus（普罗米修斯）存储经历了三个重要版本的变更v1>v2>v3，下面简述下各自版本的缺点。

### v1

2012年发布，整个数据被分为数据和原数据两部分，然后被保存在LevelDB中，并且每隔15分钟刷新一次，这样会有一个严重的问题，如果主机当机，会最长丢失15分钟的数据。v1版本有性能问题，每秒只能支持50000个样本的写入。10s周期，1000个指标，大约只能支撑500台机器的指标收集。

### v2

针对v1的问题，2015年发布了V2版本，这时候，每个时序数据用单个的文件保存，性能提高至800000样本。但是每个时序都对应一个文件，产生了严重的时序流失和写放大问题，内存使用率不断增加，经常发生OOM，同事大量文件的创建，造成了内核文件句柄过多的错误。

### v3

针对V2的问题，2017年发布了v3版本，解决了下面的问题

- 当机数据丢失的问题，引入WAL
- 每秒1000 0000个样本接受
- CPU下降3倍，磁盘IO下降10倍

普罗米修斯的本地存储也被称之为Prometheus TSDB，TSDB的设计核心包含两个，WAL和block，block有包含chunk，meta.json，index，tombstones。

最新的block被称之为head block，支持读写，其他block只读方式存储在硬盘中。



##### block

按照时间分割成block，大小不固定，按照设定的步数生成block，如：步数3，默认两小时，则第一次两小时生成一个，6小时生成一个，18小时生成一个，生成了三次。而且block会自动合并，如将3个2小时合并成一个6小时的，减少block的个数。每个block有全局唯一的uuid，这个是包含时间戳的，可以方便的排序。

block内部包含如下的几部分

- chunks 压缩后的时序数据，每个大小512M
- index 索引，为快速查询提供的索引，
- tombstones，用于对数据进行软删除，如果一个block删除了部分数据，可用这个
- meta.json 记录了block的原数据信息，开始时间，截止时间，样本数等

![tsdb](http://cdn.oyfacc.cn/prometheus-tsdb.png)

 ##### WAL

为了防止为写入磁盘的数据丢失，引入了这个机制

### 相关参数

数据保存的相关参数

- --storage.tsdb.retention 存储时间，默认15天
- --storage.tsdb.parh  存储路径